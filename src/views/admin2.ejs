<!doctype html>
<html>
  <head>
    <style>
      h1 {
        font-size: 3rem;
      }

      h2 {
        font-size: 2rem;
      }

      a {
        text-decoration: none;
        color: white;
      }

      a:hover {
        color: #ffd233;
        max-width: max-content;
      }

      body {
        background-color: black;
        color: white;
        font-family: "Courier New", Courier, monospace;
      }

      .nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 0 2rem;
      }

      ul {
        display: flex;
        justify-content: space-between;
        align-items: center;
        list-style-type: none;
        gap: 1rem;
      }

      li {
        font-size: 1.5rem;
      }

      .header-link {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 1rem;
      }

      table {
        border-collapse: collapse;
        width: 75%;
        background-color: #222222;
        border-radius: 20px;
      }

      tr:not(:last-child) {
        border: 1px solid #717171;
        border-left: none;
        border-right: none;
      }

      tr:hover:not(thead tr) {
        background-color: #454545;
        cursor: pointer;
      }

      thead {
        text-align: left;
      }

      td,
      th {
        padding: 2rem;
      }

      .workers-list {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .hidden {
        display: none;
      }

      .overview {
        display: flex;
        justify-content: space-between;
        width: 75%;
        align-items: center;
        margin: 0 auto;
      }

      .info {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        font-size: larger;
        font-weight: bold;
        flex: 1;
      }

      .info > .title {
        display: flex;
        align-items: center;
        gap: 2rem;
      }

      .credit {
        display: flex;
        justify-content: space-between;
      }

      .fund {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        flex: 1;
      }

      .fund-btn {
        background-color: #ffd233;
        border-radius: 5px;
        padding: 0.75rem;
        color: black;
        font-size: 1rem;
        transition: all 0.2s ease-in-out;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .fund-btn:hover {
        background-color: #ffe56b;
        transition: all 0.2s ease-in-out;
      }

      .fund-input {
        border: 1px solid #717171;
        border-radius: 5px;
        padding: 0.75rem;
        color: white;
        font-size: 1rem;
        transition: all 0.2s ease-in-out;
        background-color: #222222;
        margin-top: 1rem;
      }

      #funding-data {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
        margin-top: 1rem;
        flex: 1;
      }

      .compatible-frontend {
        display: flex;
        align-items: baseline;
        gap: 1rem;
      }

      .link {
        color: #73e7ee;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .link:hover {
        color: #a9e8ec;
      }

      .pill {
        padding: 0.5rem;
        border-radius: 5px;
        color: black;
        font-size: 1rem;
        transition: all 0.2s ease-in-out;
      }

      .pill:hover {
        color: black;
        transition: all 0.2s ease-in-out;
      }

      .teal {
        background-color: #73e7ee;
      }

      .purple {
        background-color: #9a73ee;
      }

      .teal:hover {
        background-color: #a9e8ec;
      }

      .purple:hover {
        background-color: #b4a1de;
      }

      .text-red {
        color: #b34646;
      }

      .text-yellow {
        color: #ffd233;
      }

      .text-green {
        color: #4ecb71;
      }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
      let selectedWorker = "<%= workers[0].worker_addr %>";
      function buildFundingSummary() {
        fetch("/api/funding_summary")
          .then((response) => response.json())
          .then((data) => {
            const fundingSummaryElement =
              document.getElementById("funding-summary");
            fundingSummaryElement.innerHTML = "";
            console.log({ data });
            data.forEach((item) => {
              // const paragraph = document.createElement('p');
              // paragraph.textContent = `Worker Address: ${item.worker_addr}, Total Amount: ${item.total_amount}, Total Credits Used: ${item.total_credits_used}`;
              // fundingSummaryElement.appendChild(paragraph);
              // Get the table body element
              const tbody = document.getElementById("funding-summary");

              // Clear existing rows
              tbody.innerHTML = "";

              // Create new rows
              data.forEach((item) => {
                console.log({ item });
                // Create a new table row
                const row = document.createElement("tr");

                // Create cells for workerAddr, total_amount, and total_credits_used and append them to the row
                ["worker_addr", "total_amount", "total_credits_used"].forEach(
                  (key) => {
                    const cell = document.createElement("td");
                    cell.textContent = item[key];
                    row.appendChild(cell);
                  },
                );

                // Append the row to the table body
                tbody.appendChild(row);
              });
            });
          })
          .catch((error) => console.error("An error occurred:", error));
      }

      function checkPayment(rHash, workerAddr) {
        const url = `/api/check_payment`;

        fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            checkingId: rHash,
            workerAddr: workerAddr,
          }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.is_paid) {
              document.getElementById("is-paid-value").innerText = "âœ…";
              document.getElementById("is-paid-key").style.color = "green";
            }

            if (data.error) {
              console.log(`server-side error: ${data.error}`);
            }
          })
          .catch((error) => {
            console.error("client-side error:", error);
          });
      }

      function fundingFormSubmit(e) {
        e.preventDefault();

        var amount = $(e.target.querySelector("#amount")).val();
        var trElem = $(e.target.parentElement.parentElement.parentElement);
        var workerAddr = selectedWorker;

        fetch("/api/funding_request", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            amount: amount,
            workerAddr: workerAddr,
          }),
        })
          .then((res) => res.json())
          .then((data) => {
            document.getElementById("qr-code").src = data.qrDataURL;
            document.getElementById("worker-name").textContent =
              "WorkerName: " + workerName;
            document.getElementById("invoice-amount").textContent =
              "Invoice Amount: " + amount;
            document.getElementById("payment-hash").textContent =
              "Payment Hash: " + data.data.payment_hash;
            document.getElementById("payment-request").textContent =
              "Payment Request: " + data.data.payment_request;
            document.getElementById("checking-id").textContent =
              "Checking ID: " + data.data.checking_id;
            document.getElementById("lnurl-response").textContent =
              "LNURL Response: " + data.data.lnurl_response;

            $(".form").hide();
            $("#funding-data").show();

            //  start polling for payment status
            setInterval(
              () => checkPayment(data.data.payment_hash, workerAddr),
              2000,
            );
          })
          .catch((error) => {
            console.error("An error occurred:", error);
            document.getElementById(
              "funding-response",
            ).textContent = `Error: ${error.message}`;
          });
      }
    </script>
  </head>
  <body>
    <section class="nav">
      <a class="header-link" href="/admin">
        <!-- Door svg -->
        <svg
          width="34"
          height="47"
          viewBox="0 0 34 47"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M2 2H25.375C27.0658 2 28.6873 2.67165 29.8828 3.86719C31.0784 5.06274 31.75 6.68424 31.75 8.375V38.125C31.75 38.6886 31.5261 39.2291 31.1276 39.6276C30.7291 40.0261 30.1886 40.25 29.625 40.25H23.25"
            stroke="#FFD233"
            stroke-width="4"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M16.875 23.25V27.5M2 2L18.1245 5.22575C19.5695 5.51457 20.8698 6.29506 21.8043 7.43446C22.7387 8.57386 23.2496 10.0018 23.25 11.4754V41.9075C23.2498 42.2218 23.1799 42.5321 23.0454 42.8161C22.9108 43.1001 22.7149 43.3507 22.4718 43.5499C22.2287 43.7491 21.9445 43.8919 21.6396 43.968C21.3347 44.0441 21.0167 44.0516 20.7085 43.99L5.417 40.9343C4.45319 40.7416 3.58595 40.2209 2.96292 39.4607C2.3399 38.7005 1.99961 37.7479 2 36.765V2Z"
            stroke="#FFD233"
            stroke-width="4"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
        <h1>Admin Panel</h1>
      </a>
      <ul>
        <li>
          <a href="/">AI-Workbench</a>
        </li>
        <li>
          <a href="/gallery">Gallery</a>
        </li>
        <li><a href="/discover">Discover</a></li>
      </ul>
    </section>
    <section class="overview">
      <aside class="info">
        <div class="title">
          <h2>bob-local</h2>
          <a
            class="pill purple"
            target="_blank"
            rel="noreferrer noopener"
            href="https://en.wikipedia.org/wiki/Stable_Diffusion"
          >
            Stable Diffusion
          </a>
          <a
            class="pill teal"
            target="_blank"
            rel="noreferrer noopener"
            href="https://civitai.com/models/4823?modelVersionId=5616"
            >Deliberate v1.1
          </a>
        </div>
        <div class="credit">
          <p>Host: 127.0.0.1:5000</p>
          <div>
            <p>Credit: <span class="text-green">100 sats</span></p>
            <p>Used: <span class="text-yellow">20 sats</span></p>
            <p>Fee: <span class="text-red">10 sats</span></p>
          </div>
        </div>
        <div class="compatible-frontend">
          Compatible Frontend:
          <a
            class="link"
            href="https://github.com/AUTOMATIC1111/stable-diffusion-webui"
            target="_blank"
            rel="noreferrer noopener"
            >Automatic 1111
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="28"
              height="28"
              viewBox="0 0 28 28"
              fill="none"
            >
              <path
                d="M12 2C10.6868 2 9.38642 2.25866 8.17317 2.7612C6.95991 3.26375 5.85752 4.00035 4.92893 4.92893C3.05357 6.8043 2 9.34784 2 12C2 16.42 4.87 20.17 8.84 21.5C9.34 21.58 9.5 21.27 9.5 21V19.31C6.73 19.91 6.14 17.97 6.14 17.97C5.68 16.81 5.03 16.5 5.03 16.5C4.12 15.88 5.1 15.9 5.1 15.9C6.1 15.97 6.63 16.93 6.63 16.93C7.5 18.45 8.97 18 9.54 17.76C9.63 17.11 9.89 16.67 10.17 16.42C7.95 16.17 5.62 15.31 5.62 11.5C5.62 10.39 6 9.5 6.65 8.79C6.55 8.54 6.2 7.5 6.75 6.15C6.75 6.15 7.59 5.88 9.5 7.17C10.29 6.95 11.15 6.84 12 6.84C12.85 6.84 13.71 6.95 14.5 7.17C16.41 5.88 17.25 6.15 17.25 6.15C17.8 7.5 17.45 8.54 17.35 8.79C18 9.5 18.38 10.39 18.38 11.5C18.38 15.32 16.04 16.16 13.81 16.41C14.17 16.72 14.5 17.33 14.5 18.26V21C14.5 21.27 14.66 21.59 15.17 21.5C19.14 20.16 22 16.42 22 12C22 10.6868 21.7413 9.38642 21.2388 8.17317C20.7362 6.95991 19.9997 5.85752 19.0711 4.92893C18.1425 4.00035 17.0401 3.26375 15.8268 2.7612C14.6136 2.25866 13.3132 2 12 2Z"
                fill="#A7A7A7"
              />
            </svg>
          </a>
        </div>
      </aside>
      <form class="fund" onsubmit="fundingFormSubmit(event)">
        <button class="fund-btn" type="submit">
          Fund Worker
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="14"
            height="22"
            viewBox="0 0 14 22"
            fill="none"
          >
            <path
              fill-rule="evenodd"
              clip-rule="evenodd"
              d="M9.0003 1.00051C9.00041 0.780676 8.92808 0.566933 8.7945 0.392343C8.66091 0.217752 8.47352 0.0920443 8.26131 0.0346652C8.0491 -0.022714 7.82389 -0.00856686 7.62053 0.0749182C7.41717 0.158403 7.24698 0.306574 7.1363 0.496509L0.136296 12.4965C0.0476155 12.6485 0.000603071 12.8212 5.76363e-06 12.9971C-0.000591544 13.1731 0.0452471 13.3461 0.132894 13.4986C0.220541 13.6512 0.346893 13.7779 0.499191 13.8661C0.65149 13.9542 0.824342 14.0006 1.0003 14.0005H5.0003V21.0005C5.00018 21.2203 5.07251 21.4341 5.2061 21.6087C5.33968 21.7833 5.52707 21.909 5.73928 21.9664C5.95149 22.0237 6.1767 22.0096 6.38006 21.9261C6.58343 21.8426 6.75361 21.6944 6.8643 21.5045L13.8643 9.50451C13.953 9.35254 14 9.17986 14.0006 9.0039C14.0012 8.82795 13.9553 8.65495 13.8677 8.50238C13.7801 8.34981 13.6537 8.22307 13.5014 8.13495C13.3491 8.04683 13.1763 8.00046 13.0003 8.00051H9.0003V1.00051Z"
              fill="black"
            />
          </svg>
        </button>
        <input
          class="fund-input"
          type="number"
          name="amount"
          id="amount"
          placeholder="Fund amount (sats)"
          value="20"
          min="1"
          required
        />
      </form>

      <div id="funding-data" style="display: none">
        <div id="funding-response">
          <img id="qr-code" src="" alt="QR Code" />
          <div id="funding-response-info">
            <p id="worker-name"></p>
            <p id="invoice-amount"></p>
            <p id="payment-hash"></p>
            <p id="payment-request"></p>
            <p id="checking-id"></p>
            <p id="lnurl-response"></p>
          </div>
        </div>
        <div id="funding-status">
          <h3 id="payment-title">
            <div id="left-section">
              <!-- <span id="prepay-title">Prepay: </span>
              <span id="prepay-amount">10 sats </span> -->
            </div>
            <div id="right-section">
              <span id="is-paid-key">is paid: </span>
              <span id="is-paid-value">ðŸ”²</span>
            </div>
          </h3>
        </div>
      </div>
    </section>
    <section class="workers-list">
      <h2>My Workers</h2>
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Fee (Sats)</th>
            <th>Credit (Sats)</th>
            <th>Preferred</th>
          </tr>
        </thead>
        <tbody>
          <% workers.forEach(function(worker, index) { %>

          <tr
            id="row-<%= index %>"
            class="switch-worker"
            data-row="<%= index %>"
            data-worker-addr="<%= worker.worker_addr %>"
          >
            <td><%= worker.name %></td>
            <td><%= worker.fee %></td>
            <td><%= worker.credits %></td>
            <td>
              <!-- Check mark svg -->
              <svg
                id="checkmark-<%= index %>"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                class="checkmark hidden"
              >
                <g clip-path="url(#clip0_5_40)">
                  <path
                    fill-rule="evenodd"
                    clip-rule="evenodd"
                    d="M21.5464 5.11101C21.8276 5.3923 21.9856 5.77376 21.9856 6.17151C21.9856 6.56925 21.8276 6.95071 21.5464 7.23201L10.3034 18.475C10.1548 18.6236 9.97845 18.7415 9.78431 18.8219C9.59016 18.9024 9.38207 18.9438 9.17193 18.9438C8.96178 18.9438 8.75369 18.9024 8.55955 18.8219C8.3654 18.7415 8.18901 18.6236 8.04043 18.475L2.45443 12.89C2.31116 12.7516 2.19689 12.5861 2.11827 12.4031C2.03966 12.2201 1.99828 12.0233 1.99655 11.8241C1.99482 11.6249 2.03277 11.4274 2.10819 11.2431C2.18362 11.0587 2.295 10.8913 2.43583 10.7504C2.57667 10.6096 2.74415 10.4982 2.9285 10.4228C3.11284 10.3474 3.31036 10.3094 3.50953 10.3111C3.7087 10.3129 3.90553 10.3542 4.08853 10.4329C4.27154 10.5115 4.43706 10.6257 4.57543 10.769L9.17143 15.365L19.4244 5.11101C19.5637 4.97162 19.7291 4.86104 19.9112 4.7856C20.0932 4.71016 20.2884 4.67133 20.4854 4.67133C20.6825 4.67133 20.8776 4.71016 21.0597 4.7856C21.2417 4.86104 21.4071 4.97162 21.5464 5.11101Z"
                    fill="#4ECB71"
                  />
                </g>
                <defs>
                  <clipPath id="clip0_5_40">
                    <rect
                      width="24"
                      height="24"
                      fill="white"
                      transform="translate(0.000427246)"
                    />
                  </clipPath>
                </defs>
              </svg>
            </td>
          </tr>
          <% }); %>
        </tbody>
      </table>
    </section>

    <script>
      $(document).ready(function () {
        buildFundingSummary();
        $(".switch-worker").click(function (e) {
          // Remove check from all rows
          $("svg.checkmark").addClass("hidden");

          // Show checkmark for the selected row
          const rowNum = $(this).data("row");
          selectedWorker = $(this).data("worker-addr");
          var rowId = `#checkmark-${rowNum}`;
          $(rowId).removeClass("hidden");
        });
      });
    </script>
  </body>
</html>
